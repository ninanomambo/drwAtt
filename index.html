<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4a4a4a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Darakwon Attendance">
    
    <!-- PWA ê´€ë ¨ ë©”íƒ€íƒœê·¸ ë° ë§í¬ -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- ì˜¤í”ˆê·¸ë˜í”„ ë©”íƒ€íƒœê·¸ -->
    <meta property="og:title" content="Darakwon Attendance - ê°„í¸í•œ ì¶œí‡´ê·¼ ê¸°ë¡ ê´€ë¦¬ ì•±">
    <meta property="og:description" content="ë‹¤ë½ì› ê·¼íƒœê¸°ë¡ ì•±">
    <meta property="og:image" content="og_image.png">
    <meta property="og:url" content="https://ninanomambo.github.io/drwAtt/">
    <meta property="og:type" content="website">
    
    <!-- íŠ¸ìœ„í„° ì¹´ë“œ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Darakwon Attendance - ê°„í¸í•œ ì¶œí‡´ê·¼ ê¸°ë¡ ê´€ë¦¬ ì•±">
    <meta name="twitter:description" content="ë‹¤ë½ì› ê·¼íƒœê¸°ë¡ ì•±">
    <meta name="twitter:image" content="og_image.png">
    
    <title>Darakwon Attendance Ver 0.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f7f7f7;
            height: 100vh;
            width: 100%;
            overflow-x: hidden;
            position: fixed;
        }
        
        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 20px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 20px);
            background-color: white;
        }
        
        .app-header {
            width: 100%;
            padding: 20px 0;
            border-bottom: 1px solid #f2f2f2;
            margin-bottom: 30px;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 500px;
            padding: 0 20px;
        }
        
        .main-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            gap: 20px;
        }
        
        .btn {
            padding: 25px 10px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }
        
        .btn-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .clock-in {
            background-color: white;
            color: #333;
            border: 2px solid #e6e6e6;
        }
        
        .clock-out {
            background-color: #4a4a4a;
            color: white;
        }
        
        .attendance-btn-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .attendance-btn {
            background-color: #f2f2f2;
            color: #555;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .attendance-btn:active {
            transform: scale(0.97);
            background-color: #e8e8e8;
        }
        
        .attendance-btn-icon {
            margin-right: 8px;
        }

        .data-management {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            width: 100%;
            flex-wrap: wrap; /* ë²„íŠ¼ì´ ë§ì•„ì§ˆ ê²½ìš° ìë™ ì¤„ë°”ê¿ˆ */
        }
        
        .data-btn {
            background-color: #f2f2f2;
            color: #555;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-width: 90px;
            max-width: 140px;
        }
        
        .data-btn:active {
            transform: scale(0.97);
            background-color: #e8e8e8;
        }
        
        .data-btn-icon {
            margin-right: 5px;
        }
        
        .status-indicator {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            display: inline-block;
        }
        
        .status-online {
            background-color: #4CAF50;
        }
        
        .status-offline {
            background-color: #F44336;
        }
        
        .sync-status {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        
        .current-time {
            text-align: center;
            font-size: 14px;
            color: #777;
            margin-top: auto;
            padding: 15px 0;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .attendance-sheet {
            background-color: white;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            margin: 20px auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            border: none;
            cursor: pointer;
        }
        
        .modal-btn-cancel {
            background-color: #f2f2f2;
            color: #555;
        }
        
        .modal-btn-save {
            background-color: #4a4a4a;
            color: white;
        }
        
        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: white;
            padding: 5px 0;
            z-index: 5;
        }
        
        .sheet-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .sheet-title span {
            margin-right: 8px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #555;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:active {
            background-color: #f2f2f2;
        }
        
        .week-section {
            margin-bottom: 25px;
        }
        
        .week-title {
            background-color: #f2f2f2;
            padding: 12px 15px;
            font-weight: 600;
            color: #333;
            border-radius: 10px 10px 0 0;
            text-align: left;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            table-layout: fixed;
        }
        
        .attendance-table th {
            background-color: #f7f7f7;
            padding: 10px 5px;
            text-align: center;
            font-weight: 500;
            color: #555;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        
        .attendance-table td {
            padding: 12px 5px;
            text-align: center;
            border-bottom: 1px solid #eee;
            color: #333;
            font-size: 13px;
            word-break: keep-all;
            white-space: nowrap;
        }
        
        .attendance-table th:first-child,
        .attendance-table td:first-child {
            width: 15%;
        }
        
        .attendance-table th:nth-child(2),
        .attendance-table td:nth-child(2) {
            width: 20%;
        }
        
        .attendance-table th:nth-child(3), 
        .attendance-table th:nth-child(4),
        .attendance-table td:nth-child(3), 
        .attendance-table td:nth-child(4) {
            width: 20%;
        }
        
        .attendance-table th:last-child,
        .attendance-table td:last-child {
            width: 25%;
        }
        
        .week-total {
            text-align: right;
            padding: 12px 15px;
            font-weight: 600;
            color: #333;
            background-color: #f9f9f9;
            border-radius: 0 0 10px 10px;
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .vibrate {
            animation: vibrate 0.3s linear;
        }
        
        @keyframes vibrate {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 80%;
            text-align: center;
            pointer-events: none;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* PWA ì„¤ì¹˜ ì•Œë¦¼ ë°°ë„ˆ ìŠ¤íƒ€ì¼ */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #4a4a4a;
            color: white;
            padding: 15px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 99;
        }
        
        .install-text {
            flex: 1;
            font-size: 14px;
        }
        
        .install-btn {
            background-color: white;
            color: #4a4a4a;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            margin: 0 10px;
            cursor: pointer;
        }
        
        .install-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }
        
        /* êµ¬ê¸€ ë“œë¼ì´ë¸Œ í†µí•© ìŠ¤íƒ€ì¼ */
        .google-section {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        .google-title {
            font-size: 14px;
            color: #555;
            text-align: center;
            margin-bottom: 10px;
        }
        
        @media (max-width: 380px) {
            .btn {
                padding: 20px 10px;
                font-size: 16px;
            }
            
            .app-title {
                font-size: 18px;
            }
            
            .attendance-table {
                font-size: 12px;
            }
            
            .attendance-table th,
            .attendance-table td {
                padding: 8px 4px;
            }
            
            .sheet-title {
                font-size: 16px;
            }
            
            .data-btn {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1 class="app-title">Darakwon Attendance Ver 0.1</h1>
        </div>
        
        <div class="main-content">
            <div class="main-buttons">
                <button class="btn clock-in" id="clockInBtn">
                    <span class="btn-icon">â°</span>
                    ì¶œê·¼
                </button>
                <button class="btn clock-out" id="clockOutBtn">
                    <span class="btn-icon">ğŸ </span>
                    í‡´ê·¼
                </button>
            </div>
            
            <div class="attendance-btn-container">
                <button class="attendance-btn" id="attendanceBtn">
                    <span class="attendance-btn-icon">ğŸ“‹</span>
                    ì¶œê·¼ë¶€
                </button>
            </div>
            
            <div class="data-management">
                <button class="data-btn" id="backupBtn">
                    <span class="data-btn-icon">ğŸ’¾</span>
                    ë°±ì—…
                </button>
                <button class="data-btn" id="restoreBtn">
                    <span class="data-btn-icon">ğŸ“‚</span>
                    ë³µì›
                </button>
                <input type="file" id="restoreInput" accept=".json" style="display: none;">
            </div>
            
            <div class="google-section">
                <div class="google-title">êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™</div>
                <div class="data-management">
                    <button class="data-btn" id="googleConfigBtn">
                        <span class="data-btn-icon">âš™ï¸</span>
                        Google ì •ë³´ì €ì¥
                    </button>
                    <button class="data-btn" id="googleBackupBtn">
                        <span class="data-btn-icon">â˜ï¸</span>
                        Google ë°±ì—…
                    </button>
                    <button class="data-btn" id="googleRestoreBtn">
                        <span class="data-btn-icon">ğŸ“¥</span>
                        Google ë³µì›
                    </button>
                </div>
            </div>
            
            <div class="sync-status" id="googleStatus">êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ì„¤ì • í•„ìš”</div>
            
            <div class="status-indicator">
                <span class="status-dot" id="storageStatus"></span>
                <span id="storageStatusText">ë°ì´í„° ì €ì¥ì†Œ: í™•ì¸ ì¤‘...</span>
            </div>
            
            <div class="current-time" id="currentTime"></div>
        </div>
    </div>
    
    <div class="overlay" id="overlay">
        <div class="attendance-sheet">
            <div class="sheet-header">
                <div class="sheet-title">
                    <span>ğŸ“‹</span> ê·¼íƒœ ì¶œê·¼ë¶€
                </div>
                <button class="close-btn" id="closeBtn">Ã—</button>
            </div>
            
            <div class="week-section" id="currentWeek">
                <div class="week-title">â–  ì´ë²ˆì£¼</div>
                <table class="attendance-table" id="currentWeekTable">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ìš”ì¼</th>
                            <th>ì¶œê·¼</th>
                            <th>í‡´ê·¼</th>
                            <th>ê·¼ë¬´ì‹œê°„</th>
                        </tr>
                    </thead>
                    <tbody id="currentWeekBody">
                        <!-- ì´ë²ˆì£¼ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                    </tbody>
                </table>
                <div class="week-total" id="currentWeekTotal">ì£¼ì¤‘ê·¼ë¬´ì‹œê°„(ì›”~ê¸ˆ): 0ì‹œê°„</div>
            </div>
            
            <div class="week-section" id="lastWeek">
                <div class="week-title">â–  ì§€ë‚œì£¼</div>
                <table class="attendance-table" id="lastWeekTable">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ìš”ì¼</th>
                            <th>ì¶œê·¼</th>
                            <th>í‡´ê·¼</th>
                            <th>ê·¼ë¬´ì‹œê°„</th>
                        </tr>
                    </thead>
                    <tbody id="lastWeekBody">
                        <!-- ì§€ë‚œì£¼ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                    </tbody>
                </table>
                <div class="week-total" id="lastWeekTotal">ì£¼ì¤‘ê·¼ë¬´ì‹œê°„(ì›”~ê¸ˆ): 0ì‹œê°„</div>
            </div>
        </div>
    </div>
    
    <!-- êµ¬ê¸€ API ì •ë³´ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal" id="googleConfigModal">
        <div class="modal-content">
            <div class="modal-title">êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ì„¤ì •</div>
            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="text" id="apiKey" placeholder="Google Cloud Consoleì—ì„œ ìƒì„±í•œ API Key">
            </div>
            <div class="form-group">
                <label for="clientId">Client ID</label>
                <input type="text" id="clientId" placeholder="Google Cloud Consoleì—ì„œ ìƒì„±í•œ Client ID">
            </div>
            <div class="form-buttons">
                <button class="modal-btn modal-btn-cancel" id="configCancelBtn">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-save" id="configSaveBtn">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- PWA ì„¤ì¹˜ ì•Œë¦¼ ë°°ë„ˆ -->
    <div class="install-banner" id="installBanner">
        <div class="install-text">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì—¬ ì•±ì²˜ëŸ¼ ì‚¬ìš©í•˜ì„¸ìš”!</div>
        <button class="install-btn" id="installBtn">ì„¤ì¹˜</button>
        <button class="install-close" id="installClose">Ã—</button>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM ìš”ì†Œ
            const clockInBtn = document.getElementById('clockInBtn');
            const clockOutBtn = document.getElementById('clockOutBtn');
            const attendanceBtn = document.getElementById('attendanceBtn');
            const overlay = document.getElementById('overlay');
            const closeBtn = document.getElementById('closeBtn');
            const currentTimeElem = document.getElementById('currentTime');
            const storageStatus = document.getElementById('storageStatus');
            const storageStatusText = document.getElementById('storageStatusText');
            const toast = document.getElementById('toast');
            const installBanner = document.getElementById('installBanner');
            const installBtn = document.getElementById('installBtn');
            const installClose = document.getElementById('installClose');
            const googleConfigBtn = document.getElementById('googleConfigBtn');
            const googleBackupBtn = document.getElementById('googleBackupBtn');
            const googleRestoreBtn = document.getElementById('googleRestoreBtn');
            const googleConfigModal = document.getElementById('googleConfigModal');
            const apiKeyInput = document.getElementById('apiKey');
            const clientIdInput = document.getElementById('clientId');
            const configSaveBtn = document.getElementById('configSaveBtn');
            const configCancelBtn = document.getElementById('configCancelBtn');
            const googleStatus = document.getElementById('googleStatus');
            
            // ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ:', registration.scope);
                        })
                        .catch(error => {
                            console.error('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', error);
                        });
                });
            }
            
            // PWA ì„¤ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                // ê¸°ë³¸ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ ë°©ì§€
                e.preventDefault();
                // ì´ë²¤íŠ¸ ì €ì¥
                deferredPrompt = e;
                // ì„¤ì¹˜ ë°°ë„ˆ í‘œì‹œ
                installBanner.style.display = 'flex';
            });
            
            // ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            installBtn.addEventListener('click', () => {
                // ë°°ë„ˆ ìˆ¨ê¸°ê¸°
                installBanner.style.display = 'none';
                // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('ì‚¬ìš©ìê°€ ì•± ì„¤ì¹˜ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤');
                            showToast('ì•±ì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤');
                        } else {
                            console.log('ì‚¬ìš©ìê°€ ì•± ì„¤ì¹˜ë¥¼ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤');
                        }
                        deferredPrompt = null;
                    });
                }
            });
            
            // ì„¤ì¹˜ ë°°ë„ˆ ë‹«ê¸° ë²„íŠ¼
            installClose.addEventListener('click', () => {
                installBanner.style.display = 'none';
            });
            
            // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë™ê¸°í™” ê´€ë¦¬ì
            const GoogleDriveManager = {
                API_KEY: null,
                CLIENT_ID: null,
                FILE_ID: null,
                FILE_NAME: 'darakwon-attendance-data.json',
                API_DISCOVERY_DOCS: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                API_SCOPES: 'https://www.googleapis.com/auth/drive.file',
                isInitialized: false,
                
                // êµ¬ê¸€ ì •ë³´ ë¡œë“œ
                loadConfig: function() {
                    try {
                        const googleConfig = localStorage.getItem('googleDriveConfig');
                        if (googleConfig) {
                            const config = JSON.parse(googleConfig);
                            this.API_KEY = config.apiKey;
                            this.CLIENT_ID = config.clientId;
                            this.FILE_ID = config.fileId;
                            
                            // UI ìš”ì†Œ ì—…ë°ì´íŠ¸
                            apiKeyInput.value = this.API_KEY;
                            clientIdInput.value = this.CLIENT_ID;
                            
                            return true;
                        }
                        return false;
                    } catch (error) {
                        console.error('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
                        return false;
                    }
                },
                
                // êµ¬ê¸€ ì •ë³´ ì €ì¥
                saveConfig: function(apiKey, clientId, fileId = null) {
                    try {
                        this.API_KEY = apiKey;
                        this.CLIENT_ID = clientId;
                        if (fileId) this.FILE_ID = fileId;
                        
                        const config = {
                            apiKey: this.API_KEY,
                            clientId: this.CLIENT_ID,
                            fileId: this.FILE_ID
                        };
                        
                        localStorage.setItem('googleDriveConfig', JSON.stringify(config));
                        return true;
                    } catch (error) {
                        console.error('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
                        return false;
                    }
                },
                
                // Google API ë¡œë“œ ë° ì´ˆê¸°í™”
                init: function() {
                    if (!this.API_KEY || !this.CLIENT_ID) {
                        googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: API í‚¤ ë° í´ë¼ì´ì–¸íŠ¸ ID ì„¤ì • í•„ìš”';
                        return Promise.reject(new Error('API í‚¤ ë° í´ë¼ì´ì–¸íŠ¸ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'));
                    }
                    
                    return new Promise((resolve, reject) => {
                        // Google API í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì´ë¯¸ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                        if (window.gapi && window.gapi.client) {
                            this.initClient().then(resolve).catch(reject);
                            return;
                        }
                        
                        // Google API í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
                        const script = document.createElement('script');
                        script.src = 'https://apis.google.com/js/api.js';
                        script.onload = () => {
                            gapi.load('client:auth2', () => {
                                this.initClient().then(resolve).catch(reject);
                            });
                        };
                        script.onerror = (error) => reject(error);
                        document.body.appendChild(script);
                    });
                },
                
                // API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
                initClient: function() {
                    return gapi.client.init({
                        apiKey: this.API_KEY,
                        clientId: this.CLIENT_ID,
                        discoveryDocs: this.API_DISCOVERY_DOCS,
                        scope: this.API_SCOPES
                    }).then(() => {
                        // ë¡œê·¸ì¸ ìƒíƒœ ì´ˆê¸°í™”
                        if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                            this.isInitialized = true;
                            googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ì—°ê²°ë¨';
                            // íŒŒì¼ IDê°€ ì—†ìœ¼ë©´ ì°¾ê¸°
                            if (!this.FILE_ID) {
                                return this.findOrCreateFile().then(() => {
                                    return true;
                                });
                            }
                            return true;
                        } else {
                            googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ë¡œê·¸ì¸ í•„ìš”';
                            return this.signIn();
                        }
                    }).catch(error => {
                        googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ì´ˆê¸°í™” ì‹¤íŒ¨';
                        console.error('êµ¬ê¸€ API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                        throw error;
                    });
                },
                
                // ë¡œê·¸ì¸
                signIn: function() {
                    if (!gapi || !gapi.auth2) {
                        return Promise.reject(new Error('Google APIê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'));
                    }
                    
                    return gapi.auth2.getAuthInstance().signIn()
                        .then(() => {
                            this.isInitialized = true;
                            googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ë¡œê·¸ì¸ ì„±ê³µ';
                            // íŒŒì¼ IDê°€ ì—†ìœ¼ë©´ ì°¾ê¸°
                            if (!this.FILE_ID) {
                                return this.findOrCreateFile();
                            }
                            return true;
                        })
                        .catch(error => {
                            googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ë¡œê·¸ì¸ ì‹¤íŒ¨';
                            console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                            throw error;
                        });
                },
                
                // íŒŒì¼ ì°¾ê¸° ë˜ëŠ” ìƒì„±í•˜ê¸°
                findOrCreateFile: function() {
                    return new Promise((resolve, reject) => {
                        // íŒŒì¼ ê²€ìƒ‰
                        gapi.client.drive.files.list({
                            q: `name='${this.FILE_NAME}' and trashed=false`,
                            spaces: 'drive',
                            fields: 'files(id, name, modifiedTime)'
                        }).then(response => {
                            const files = response.result.files;
                            if (files && files.length > 0) {
                                // íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ ID ì €ì¥
                                this.FILE_ID = files[0].id;
                                this.saveConfig(this.API_KEY, this.CLIENT_ID, this.FILE_ID);
                                googleStatus.textContent = `êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: íŒŒì¼ ì°¾ìŒ (ë§ˆì§€ë§‰ ìˆ˜ì •: ${new Date(files[0].modifiedTime).toLocaleString()})`;
                                resolve(this.FILE_ID);
                            } else {
                                // íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                                return this.createFile().then(fileId => {
                                    resolve(fileId);
                                });
                            }
                        }).catch(error => {
                            console.error('íŒŒì¼ ì°¾ê¸° ì˜¤ë¥˜:', error);
                            reject(error);
                        });
                    });
                },
                
                // ìƒˆ íŒŒì¼ ìƒì„±í•˜ê¸°
                createFile: function() {
                    return new Promise((resolve, reject) => {
                        // ë¹ˆ JSON ê°ì²´ë¡œ ì´ˆê¸°í™”í•  íŒŒì¼ ë‚´ìš©
                        const fileContent = JSON.stringify({});
                        
                        // íŒŒì¼ ë©”íƒ€ë°ì´í„°
                        const metadata = {
                            name: this.FILE_NAME,
                            mimeType: 'application/json'
                        };
                        
                        // ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¡œ ë³€í™˜
                        const blob = new Blob([fileContent], {type: 'application/json'});
                        
                        // íŒŒì¼ ìƒì„± ìš”ì²­
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                        form.append('file', blob);
                        
                        fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST',
                            headers: new Headers({
                                'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token
                            }),
                            body: form
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.id) {
                                this.FILE_ID = data.id;
                                this.saveConfig(this.API_KEY, this.CLIENT_ID, this.FILE_ID);
                                googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ìƒˆ íŒŒì¼ ìƒì„±ë¨';
                                resolve(this.FILE_ID);
                            } else {
                                reject(new Error('íŒŒì¼ ìƒì„± ì‘ë‹µì—ì„œ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
                            }
                        })
                        .catch(error => {
                            console.error('íŒŒì¼ ìƒì„± ì˜¤ë¥˜:', error);
                            reject(error);
                        });
                    });
                },
                
                // íŒŒì¼ ë°±ì—… (ê¸°ì¡´ íŒŒì¼ ë®ì–´ì“°ê¸°)
                backupFile: function(jsonData) {
                    return new Promise((resolve, reject) => {
                        if (!this.isInitialized) {
                            this.init().then(() => {
                                this.backupFile(jsonData).then(resolve).catch(reject);
                            }).catch(reject);
                            return;
                        }
                        
                        if (!this.FILE_ID) {
                            this.findOrCreateFile().then(() => {
                                this.backupFile(jsonData).then(resolve).catch(reject);
                            }).catch(reject);
                            return;
                        }
                        
                        // ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¡œ ë³€í™˜
                        const blob = new Blob([jsonData], {type: 'application/json'});
                        
                        // íŒŒì¼ ì—…ë°ì´íŠ¸ ìš”ì²­
                        fetch(`https://www.googleapis.com/upload/drive/v3/files/${this.FILE_ID}?uploadType=media`, {
                            method: 'PATCH',
                            headers: new Headers({
                                'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token,
                                'Content-Type': 'application/json'
                            }),
                            body: jsonData
                        })
                        .then(response => {
                            if (response.ok) {
                                googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ë°±ì—… ì™„ë£Œ (' + new Date().toLocaleString() + ')';
                                resolve(true);
                            } else {
                                return response.json().then(data => {
                                    reject(new Error(`íŒŒì¼ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${data.error ? data.error.message : response.statusText}`));
                                });
                            }
                        })
                        .catch(error => {
                            console.error('íŒŒì¼ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                            reject(error);
                        });
                    });
                },
                
                // íŒŒì¼ ë³µì› (íŒŒì¼ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
                restoreFile: function() {
                    return new Promise((resolve, reject) => {
                        if (!this.isInitialized) {
                            this.init().then(() => {
                                this.restoreFile().then(resolve).catch(reject);
                            }).catch(reject);
                            return;
                        }
                        
                        if (!this.FILE_ID) {
                            this.findOrCreateFile().then(() => {
                                this.restoreFile().then(resolve).catch(reject);
                            }).catch(reject);
                            return;
                        }
                        
                        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­
                        fetch(`https://www.googleapis.com/drive/v3/files/${this.FILE_ID}?alt=media`, {
                            headers: new Headers({
                                'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token
                            })
                        })
                        .then(response => {
                            if (response.ok) {
                                return response.text();
                            } else {
                                return response.json().then(data => {
                                    throw new Error(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${data.error ? data.error.message : response.statusText}`);
                                });
                            }
                        })
                        .then(content => {
                            // ìœ íš¨í•œ JSONì¸ì§€ í™•ì¸
                            try {
                                const jsonData = JSON.parse(content);
                                googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ë³µì› ì™„ë£Œ (' + new Date().toLocaleString() + ')';
                                resolve(jsonData);
                            } catch (error) {
                                reject(new Error('íŒŒì¼ ë‚´ìš©ì´ ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'));
                            }
                        })
                        .catch(error => {
                            console.error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                            reject(error);
                        });
                    });
                }
            };
            
            // ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ì - IndexedDB, localStorage ë˜ëŠ” ë©”ëª¨ë¦¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
            const StorageManager = {
                memoryStorage: {},
                isIndexedDBAvailable: false,
                isLocalStorageAvailable: false,
                dbName: 'DarakwonAttendanceDB',
                storeName: 'attendanceData',
                db: null,
                
                // ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ ë° ì´ˆê¸°í™”
                init: function() {
                    return new Promise((resolve) => {
                        // IndexedDB ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                        if ('indexedDB' in window) {
                            const request = indexedDB.open(this.dbName, 1);
                            
                            request.onerror = () => {
                                console.log('IndexedDB ì‚¬ìš© ë¶ˆê°€: ëŒ€ì²´ ë°©ë²• ì‹œë„');
                                this.tryLocalStorage();
                                resolve();
                            };
                            
                            request.onupgradeneeded = (event) => {
                                const db = event.target.result;
                                if (!db.objectStoreNames.contains(this.storeName)) {
                                    db.createObjectStore(this.storeName);
                                }
                            };
                            
                            request.onsuccess = (event) => {
                                this.db = event.target.result;
                                this.isIndexedDBAvailable = true;
                                storageStatus.classList.add('status-online');
                                storageStatusText.textContent = 'ë°ì´í„° ì €ì¥ì†Œ: IndexedDB ì‚¬ìš© ì¤‘ (ì˜êµ¬ ì €ì¥)';
                                resolve();
                            };
                        } else {
                            this.tryLocalStorage();
                            resolve();
                        }
                    });
                },
                
                // localStorage ì‚¬ìš© ì‹œë„
                tryLocalStorage: function() {
                    try {
                        localStorage.setItem('test', 'test');
                        localStorage.removeItem('test');
                        this.isLocalStorageAvailable = true;
                        storageStatus.classList.add('status-online');
                        storageStatusText.textContent = 'ë°ì´í„° ì €ì¥ì†Œ: ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš© ì¤‘ (ì˜êµ¬ ì €ì¥)';
                    } catch (e) {
                        this.useMemoryStorage();
                    }
                },
                
                // ë©”ëª¨ë¦¬ ì €ì¥ì†Œ ì‚¬ìš©
                useMemoryStorage: function() {
                    this.isIndexedDBAvailable = false;
                    this.isLocalStorageAvailable = false;
                    storageStatus.classList.add('status-offline');
                    storageStatusText.textContent = 'ë°ì´í„° ì €ì¥ì†Œ: ì„ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš© ì¤‘ (ì•± ì¢…ë£Œ ì‹œ ë°ì´í„° ì‚­ì œ)';
                    showToast('ì£¼ì˜: í˜„ì¬ ì„ì‹œ ì €ì¥ì†Œë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹«ìœ¼ë©´ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.', 5000);
                },
                
                // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                getItem: function(key) {
                    return new Promise((resolve) => {
                        // IndexedDB ì‚¬ìš©
                        if (this.isIndexedDBAvailable) {
                            const transaction = this.db.transaction([this.storeName], 'readonly');
                            const store = transaction.objectStore(this.storeName);
                            const request = store.get(key);
                            
                            request.onsuccess = () => {
                                resolve(request.result);
                            };
                            
                            request.onerror = () => {
                                console.error('IndexedDB ë°ì´í„° ì½ê¸° ì˜¤ë¥˜');
                                resolve(null);
                            };
                        } 
                        // localStorage ì‚¬ìš©
                        else if (this.isLocalStorageAvailable) {
                            resolve(localStorage.getItem(key));
                        } 
                        // ë©”ëª¨ë¦¬ ì‚¬ìš©
                        else {
                            resolve(this.memoryStorage[key]);
                        }
                    });
                },
                
                // ë°ì´í„° ì €ì¥í•˜ê¸°
                setItem: function(key, value) {
                    return new Promise((resolve) => {
                        // IndexedDB ì‚¬ìš©
                        if (this.isIndexedDBAvailable) {
                            const transaction = this.db.transaction([this.storeName], 'readwrite');
                            const store = transaction.objectStore(this.storeName);
                            const request = store.put(value, key);
                            
                            request.onsuccess = () => {
                                resolve(true);
                            };
                            
                            request.onerror = () => {
                                console.error('IndexedDB ë°ì´í„° ì €ì¥ ì˜¤ë¥˜');
                                resolve(false);
                            };
                        } 
                        // localStorage ì‚¬ìš©
                        else if (this.isLocalStorageAvailable) {
                            try {
                                localStorage.setItem(key, value);
                                resolve(true);
                            } catch (e) {
                                console.error('localStorage ì €ì¥ ì˜¤ë¥˜', e);
                                resolve(false);
                            }
                        } 
                        // ë©”ëª¨ë¦¬ ì‚¬ìš©
                        else {
                            this.memoryStorage[key] = value;
                            resolve(true);
                        }
                    });
                },
                
                // ë°ì´í„° ì‚­ì œí•˜ê¸°
                removeItem: function(key) {
                    return new Promise((resolve) => {
                        // IndexedDB ì‚¬ìš©
                        if (this.isIndexedDBAvailable) {
                            const transaction = this.db.transaction([this.storeName], 'readwrite');
                            const store = transaction.objectStore(this.storeName);
                            const request = store.delete(key);
                            
                            request.onsuccess = () => {
                                resolve(true);
                            };
                            
                            request.onerror = () => {
                                console.error('IndexedDB ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜');
                                resolve(false);
                            };
                        } 
                        // localStorage ì‚¬ìš©
                        else if (this.isLocalStorageAvailable) {
                            localStorage.removeItem(key);
                            resolve(true);
                        } 
                        // ë©”ëª¨ë¦¬ ì‚¬ìš©
                        else {
                            delete this.memoryStorage[key];
                            resolve(true);
                        }
                    });
                }
            };
            
            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
            function showToast(message, duration = 2000) {
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }
            
            // ì§„ë™ íš¨ê³¼ í•¨ìˆ˜ (ëª¨ë°”ì¼)
            function vibrate(element) {
                element.classList.add('vibrate');
                setTimeout(() => {
                    element.classList.remove('vibrate');
                }, 300);
                
                // ëª¨ë°”ì¼ ê¸°ê¸° ì§„ë™ API (ì§€ì›ë˜ëŠ” ê²½ìš°)
                if ('vibrate' in navigator) {
                    navigator.vibrate(100);
                }
            }
            
            // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateCurrentTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                currentTimeElem.textContent = `í˜„ì¬ ì‹œê°„: ${hours}:${minutes}:${seconds}`;
            }
            
            // 1ì´ˆë§ˆë‹¤ í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
            setInterval(updateCurrentTime, 1000);
            updateCurrentTime();
            
            // ë‚ ì§œ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜
            function formatDate(date) {
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${month}ì›”-${day}ì¼ ${hours}:${minutes}`;
            }
            
            // ìš”ì¼ êµ¬í•˜ê¸° í•¨ìˆ˜
            function getDayOfWeek(date) {
                const days = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
                return days[date.getDay()];
            }
            
            // ë‚ ì§œë¡œë¶€í„° ì£¼ ì‹œì‘ì¼ êµ¬í•˜ê¸° (ì¼ìš”ì¼ ê¸°ì¤€)
            function getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay(); // 0 = ì¼ìš”ì¼, 1 = ì›”ìš”ì¼, ...
                d.setDate(d.getDate() - day); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼ë¡œ ì„¤ì •
                d.setHours(0, 0, 0, 0); // ìì •ìœ¼ë¡œ ì„¤ì •
                return d;
            }
            
            // IndexedDB ë˜ëŠ” ë‹¤ë¥¸ ì €ì¥ì†Œì—ì„œ ì¶œí‡´ê·¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            async function getAttendanceData() {
                const data = await StorageManager.getItem('attendanceData');
                return data ? JSON.parse(data) : {};
            }
            
            // ì¶œí‡´ê·¼ ë°ì´í„° ì €ì¥
            async function saveAttendanceData(data) {
                await StorageManager.setItem('attendanceData', JSON.stringify(data));
            }
            
            // ì¶œê·¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            clockInBtn.addEventListener('click', async function() {
                vibrate(this);
                const now = new Date();
                const dateKey = now.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
                const attendanceData = await getAttendanceData();
                
                // ì´ë¯¸ ì¶œê·¼ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
                if (!attendanceData[dateKey] || !attendanceData[dateKey].clockIn) {
                    attendanceData[dateKey] = attendanceData[dateKey] || {};
                    attendanceData[dateKey].clockIn = now.getTime();
                    await saveAttendanceData(attendanceData);
                    
                    showToast('ì¶œê·¼ ì‹œê°„ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: ' + formatDate(now));
                } else {
                    showToast('ì´ë¯¸ ì¶œê·¼ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤: ' + formatDate(new Date(attendanceData[dateKey].clockIn)));
                }
                
                // 2ì£¼ê°€ ì§€ë‚œ ë°ì´í„° ì‚­ì œ
                await cleanupOldData();
            });
            
            // í‡´ê·¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            clockOutBtn.addEventListener('click', async function() {
                vibrate(this);
                const now = new Date();
                const dateKey = now.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
                const attendanceData = await getAttendanceData();
                
                if (!attendanceData[dateKey]) {
                    showToast('ì˜¤ëŠ˜ ì¶œê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¶œê·¼ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // í‡´ê·¼ ì‹œê°„ì€ í•­ìƒ ì—…ë°ì´íŠ¸
                attendanceData[dateKey].clockOut = now.getTime();
                await saveAttendanceData(attendanceData);
                
                showToast('í‡´ê·¼ ì‹œê°„ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: ' + formatDate(now));
                
                // 2ì£¼ê°€ ì§€ë‚œ ë°ì´í„° ì‚­ì œ
                await cleanupOldData();
            });
            
            // 2ì£¼ ì´ìƒ ì§€ë‚œ ë°ì´í„° ì‚­ì œ
            async function cleanupOldData() {
                const attendanceData = await getAttendanceData();
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                twoWeeksAgo.setHours(0, 0, 0, 0);
                
                let hasChanges = false;
                
                for (const dateKey in attendanceData) {
                    const recordDate = new Date(dateKey);
                    if (recordDate < twoWeeksAgo) {
                        delete attendanceData[dateKey];
                        hasChanges = true;
                    }
                }
                
                if (hasChanges) {
                    await saveAttendanceData(attendanceData);
                }
            }
            
            // ê·¼ë¬´ ì‹œê°„ ê³„ì‚° (ì ì‹¬ ì‹œê°„ ì œì™¸, 11ì‹œê°„ ì´ˆê³¼ ì‹œ ì €ë… ì‹œê°„ ì œì™¸)
            function calculateWorkHours(clockIn, clockOut) {
                if (!clockIn || !clockOut) return 0;
                
                const inTime = new Date(clockIn);
                const outTime = new Date(clockOut);
                
                // ì´ ê·¼ë¬´ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
                let totalMs = outTime - inTime;
                
                // ì ì‹¬ ì‹œê°„ ê³„ì‚° (11:30 ~ 12:00)
                const inDate = new Date(inTime);
                const lunchStart = new Date(inDate.setHours(11, 30, 0, 0));
                const lunchEnd = new Date(inDate.setHours(12, 0, 0, 0));
                
                // ì ì‹¬ ì‹œê°„ì´ ê·¼ë¬´ ì‹œê°„ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (inTime <= lunchEnd && outTime >= lunchStart) {
                    // ì ì‹¬ ì‹œê°„ì˜ ê²¹ì¹˜ëŠ” ë¶€ë¶„ ê³„ì‚°
                    const lunchOverlapStart = Math.max(inTime.getTime(), lunchStart.getTime());
                    const lunchOverlapEnd = Math.min(outTime.getTime(), lunchEnd.getTime());
                    const lunchOverlapMs = lunchOverlapEnd - lunchOverlapStart;
                    
                    // ê²¹ì¹˜ëŠ” ì ì‹¬ ì‹œê°„ ì œì™¸
                    totalMs -= lunchOverlapMs;
                }
                
                // 11ì‹œê°„ ì´ˆê³¼ ê·¼ë¬´ì¸ ê²½ìš° ì €ë… ì‹œê°„ 1ì‹œê°„ ì œì™¸
                const elevenHoursMs = 11 * 60 * 60 * 1000;
                if (totalMs > elevenHoursMs) {
                    totalMs -= 60 * 60 * 1000; // 1ì‹œê°„ (60ë¶„ * 60ì´ˆ * 1000ë°€ë¦¬ì´ˆ)
                }
                
                // ì‹œê°„ìœ¼ë¡œ ë³€í™˜ (ë°€ë¦¬ì´ˆ -> ì‹œê°„)
                const hours = Math.max(0, totalMs / (1000 * 60 * 60));
                return hours;
            }
            
            // ì¶œê·¼ë¶€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            attendanceBtn.addEventListener('click', async function() {
                vibrate(this);
                await renderAttendanceSheet();
                overlay.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€
            });
            
            // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            closeBtn.addEventListener('click', function() {
                overlay.style.display = 'none';
                document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›
            });
            
            // ë°°ê²½ í´ë¦­ ì‹œ ì¶œê·¼ë¶€ ë‹«ê¸°
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                    document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›
                }
            });
            
            // í„°ì¹˜ ì´ë²¤íŠ¸ ì·¨ì†Œ (ìŠ¤ì™€ì´í”„ ë°©ì§€)
            overlay.addEventListener('touchmove', function(e) {
                e.stopPropagation();
            }, { passive: false });
            
            // ì¶œê·¼ë¶€ ë Œë”ë§
            async function renderAttendanceSheet() {
                try {
                    const attendanceData = await getAttendanceData();
                    const today = new Date();
                    
                    // ì´ë²ˆ ì£¼ ì‹œì‘ì¼ (ì¼ìš”ì¼)
                    const currentWeekStart = getWeekStart(today);
                    
                    // ì§€ë‚œ ì£¼ ì‹œì‘ì¼ (ì´ë²ˆì£¼ ì‹œì‘ì¼ - 7ì¼)
                    const lastWeekStart = new Date(currentWeekStart);
                    lastWeekStart.setDate(lastWeekStart.getDate() - 7);
                    
                    // ì´ë²ˆ ì£¼ ë°ì´í„° ë Œë”ë§
                    renderWeekData(currentWeekStart, 'currentWeekBody', 'currentWeekTotal', attendanceData);
                    
                    // ì§€ë‚œ ì£¼ ë°ì´í„° ë Œë”ë§
                    renderWeekData(lastWeekStart, 'lastWeekBody', 'lastWeekTotal', attendanceData);
                } catch (error) {
                    console.error('ì¶œê·¼ë¶€ ë Œë”ë§ ì˜¤ë¥˜:', error);
                    showToast('ì¶œê·¼ë¶€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                }
            }
            
            // ì£¼ê°„ ë°ì´í„° ë Œë”ë§
            function renderWeekData(weekStart, tableBodyId, totalId, attendanceData) {
                const tableBody = document.getElementById(tableBodyId);
                tableBody.innerHTML = '';
                
                let weekdayTotalHours = 0; // ì£¼ì¤‘(ì›”~ê¸ˆ) ì´ ê·¼ë¬´ ì‹œê°„
                
                // í•´ë‹¹ ì£¼ì˜ 7ì¼ ë°ì´í„° ë Œë”ë§
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(date.getDate() + i);
                    
                    const dateKey = date.toISOString().split('T')[0];
                    const dayRecord = attendanceData[dateKey] || {};
                    
                    const row = document.createElement('tr');
                    
                    // ë‚ ì§œ
                    const dateCell = document.createElement('td');
                    dateCell.textContent = `${date.getDate()}ì¼`;
                    row.appendChild(dateCell);
                    
                    // ìš”ì¼
                    const dayCell = document.createElement('td');
                    const dayOfWeek = getDayOfWeek(date);
                    dayCell.textContent = dayOfWeek;
                    row.appendChild(dayCell);
                    
                    // ì¶œê·¼ ì‹œê°„
                    const clockInCell = document.createElement('td');
                    if (dayRecord.clockIn) {
                        const clockInDate = new Date(dayRecord.clockIn);
                        clockInCell.textContent = `${String(clockInDate.getHours()).padStart(2, '0')}:${String(clockInDate.getMinutes()).padStart(2, '0')}`;
                    } else {
                        clockInCell.textContent = '-';
                    }
                    row.appendChild(clockInCell);
                    
                    // í‡´ê·¼ ì‹œê°„
                    const clockOutCell = document.createElement('td');
                    if (dayRecord.clockOut) {
                        const clockOutDate = new Date(dayRecord.clockOut);
                        clockOutCell.textContent = `${String(clockOutDate.getHours()).padStart(2, '0')}:${String(clockOutDate.getMinutes()).padStart(2, '0')}`;
                    } else {
                        clockOutCell.textContent = '-';
                    }
                    row.appendChild(clockOutCell);
                    
                    // ê·¼ë¬´ ì‹œê°„
                    const workHoursCell = document.createElement('td');
                    const workHours = calculateWorkHours(dayRecord.clockIn, dayRecord.clockOut);
                    
                    if (workHours > 0) {
                        workHoursCell.textContent = `${workHours.toFixed(1)}ì‹œê°„`;
                        
                        // í‰ì¼(ì›”~ê¸ˆ)ì¸ ê²½ìš°ì—ë§Œ ì´ ê·¼ë¬´ ì‹œê°„ì— ì¶”ê°€
                        const day = date.getDay();
                        if (day >= 1 && day <= 5) { // 1=ì›”ìš”ì¼, 5=ê¸ˆìš”ì¼
                            weekdayTotalHours += workHours;
                        }
                    } else {
                        workHoursCell.textContent = '-';
                    }
                    row.appendChild(workHoursCell);
                    
                    tableBody.appendChild(row);
                }
                
                // ì£¼ì¤‘ ì´ ê·¼ë¬´ ì‹œê°„ ì—…ë°ì´íŠ¸
                document.getElementById(totalId).textContent = `ì£¼ì¤‘ê·¼ë¬´ì‹œê°„(ì›”~ê¸ˆ): ${weekdayTotalHours.toFixed(1)}ì‹œê°„`;
            }
            
            // ë°ì´í„° ë‚´ë³´ë‚´ê¸° - ë°±ì—… ê¸°ëŠ¥
            function exportData() {
                return new Promise(async (resolve, reject) => {
                    try {
                        const data = await getAttendanceData();
                        const dataStr = JSON.stringify(data);
                        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                        
                        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        const exportFileDefaultName = 'darakwon-attendance-backup.json';
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        linkElement.click();
                        resolve(true);
                    } catch (error) {
                        console.error("ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:", error);
                        reject(error);
                    }
                });
            }
            
            // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° - ë³µì› ê¸°ëŠ¥
            function importData(jsonData) {
                return new Promise(async (resolve, reject) => {
                    try {
                        const data = JSON.parse(jsonData);
                        await saveAttendanceData(data);
                        await renderAttendanceSheet();
                        resolve(true);
                    } catch (error) {
                        console.error("ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
                        reject(error);
                    }
                });
            }
            
            // ë°ì´í„° ë°±ì—… ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('backupBtn').addEventListener('click', async function() {
                vibrate(this);
                try {
                    await exportData();
                    showToast('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
                } catch (error) {
                    showToast('ë°±ì—… ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                }
            });
            
            // ë°ì´í„° ë³µì› íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
            document.getElementById('restoreInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        await importData(e.target.result);
                        showToast('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤');
                    } catch (error) {
                        showToast('ë°ì´í„° ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                    }
                };
                reader.readAsText(file);
            });
            
            // ë³µì› ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
            document.getElementById('restoreBtn').addEventListener('click', function() {
                vibrate(this);
                document.getElementById('restoreInput').click();
            });
            
            // êµ¬ê¸€ API ì •ë³´ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            googleConfigBtn.addEventListener('click', function() {
                vibrate(this);
                
                // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                GoogleDriveManager.loadConfig();
                
                // ëª¨ë‹¬ í‘œì‹œ
                googleConfigModal.style.display = 'flex';
            });
            
            // êµ¬ê¸€ ì„¤ì • ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            configSaveBtn.addEventListener('click', async function() {
                const apiKey = apiKeyInput.value.trim();
                const clientId = clientIdInput.value.trim();
                
                if (!apiKey || !clientId) {
                    showToast('API Keyì™€ Client IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ì„¤ì • ì €ì¥
                if (GoogleDriveManager.saveConfig(apiKey, clientId)) {
                    googleConfigModal.style.display = 'none';
                    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // êµ¬ê¸€ API ì´ˆê¸°í™” ì‹œë„
                    try {
                        await GoogleDriveManager.init();
                        showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } catch (error) {
                        console.error('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                        showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    showToast('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
            
            // êµ¬ê¸€ ì„¤ì • ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            configCancelBtn.addEventListener('click', function() {
                googleConfigModal.style.display = 'none';
            });
            
            // êµ¬ê¸€ ë°±ì—… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            googleBackupBtn.addEventListener('click', async function() {
                vibrate(this);
                
                // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì • í™•ì¸
                if (!GoogleDriveManager.API_KEY || !GoogleDriveManager.CLIENT_ID) {
                    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    googleConfigBtn.click(); // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
                    return;
                }
                
                try {
                    // í˜„ì¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const data = await getAttendanceData();
                    const jsonData = JSON.stringify(data);
                    
                    // êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…
                    await GoogleDriveManager.backupFile(jsonData);
                    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°±ì—… ì˜¤ë¥˜:', error);
                    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            });
            
            // êµ¬ê¸€ ë³µì› ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            googleRestoreBtn.addEventListener('click', async function() {
                vibrate(this);
                
                // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì • í™•ì¸
                if (!GoogleDriveManager.API_KEY || !GoogleDriveManager.CLIENT_ID) {
                    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    googleConfigBtn.click(); // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°
                    return;
                }
                
                try {
                    // êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„° ë³µì›
                    const data = await GoogleDriveManager.restoreFile();
                    
                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    await saveAttendanceData(data);
                    
                    // ì¶œê·¼ë¶€ ë‹¤ì‹œ ë Œë”ë§
                    await renderAttendanceSheet();
                    
                    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë³µì› ì˜¤ë¥˜:', error);
                    showToast('êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            });
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            googleConfigModal.addEventListener('click', function(e) {
                if (e.target === googleConfigModal) {
                    googleConfigModal.style.display = 'none';
                }
            });
            
            // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            // ì•± ì´ˆê¸°í™” í•¨ìˆ˜
            async function initApp() {
                // ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”
                await StorageManager.init();
                
                // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì„¤ì • ë¡œë“œ
                if (GoogleDriveManager.loadConfig()) {
                    googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ì„¤ì •ë¨ (ì—°ê²° ëŒ€ê¸° ì¤‘)';
                } else {
                    googleStatus.textContent = 'êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìƒíƒœ: ì„¤ì • í•„ìš”';
                }
                
                // ì•±ì´ ë¡œë“œë  ë•Œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
                setTimeout(() => {
                    showToast('Darakwon Attendance ì•±ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤', 3000);
                }, 500);
                
                // ì´ˆê¸°í™” ì‹œ ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
                cleanupOldData();
            }
            
            // ì•± ì´ˆê¸°í™”
            initApp();
        });
    </script>
</body>
</html>